name: ML Pipeline - Train, Artifacts, Docker

on:
  push:
    branches: [""]
  workflow_dispatch:

jobs:
  ml_pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    # -------------------------
    # Provide MLflow credentials for remote tracking (optional)
    # -------------------------
    - name: Set MLflow env (optional DagsHub)
      if: ${{ secrets.MLFLOW_TRACKING_URI != '' }}
      run: |
        echo "MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_USERNAME=${{ secrets.MLFLOW_TRACKING_USERNAME }}" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_PASSWORD=${{ secrets.MLFLOW_TRACKING_PASSWORD }}" >> $GITHUB_ENV
        echo "MLFLOW_EXPERIMENT_NAME=${{ secrets.MLFLOW_EXPERIMENT_NAME }}" >> $GITHUB_ENV

    # -------------------------
    # Run training
    # -------------------------
    - name: Run training (modelling.py)
      run: |
        python modelling.py
        ls -la
        ls -la rf_model || true

    # -------------------------
    # Upload artifacts to GitHub Actions (for download)
    # -------------------------
    - name: Upload artifacts to Actions
      uses: actions/upload-artifact@v4
      with:
        name: churn-artifacts
        path: |
          model.pkl
          rf_model
          confusion_matrix.png
          feature_importance.png
          classification_report.txt
        retention-days: 7

    # -------------------------
    # Create GitHub Release and attach key artifacts
    # -------------------------
    - name: Create GitHub Release (attach plots + report)
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "model-$(date +'%Y%m%d-%H%M%S')"
        name: "Churn model release ${{ github.run_id }}"
        files: |
          confusion_matrix.png
          feature_importance.png
          classification_report.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # -------------------------
    # Optional: upload to Google Drive (if secrets provided)
    # -------------------------
    - name: Upload to Google Drive (optional)
      if: ${{ secrets.GDRIVE_CREDENTIALS != '' && secrets.GDRIVE_FOLDER_ID != '' }}
      run: |
        pip install gdown
        echo '${{ secrets.GDRIVE_CREDENTIALS }}' > gdrive_creds.json
        gdown --service-account gdrive_creds.json --upload model.pkl --parent ${{ secrets.GDRIVE_FOLDER_ID }}

    # -------------------------
    # Build Docker image from local rf_model (mlflow models build-docker)
    # -------------------------
    - name: Build MLflow Docker image
      run: |
        # make sure rf_model exists
        if [ ! -d "rf_model" ]; then echo "rf_model not found"; exit 1; fi
        mlflow models build-docker --model-uri rf_model -n churn-mlflow-image

    # -------------------------
    # Docker login & push
    # -------------------------
    - name: Docker login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Tag & Push image
      run: |
        docker tag churn-mlflow-image:latest ${{ secrets.DOCKERHUB_USERNAME }}/churn-ml-model:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/churn-ml-model:latest
